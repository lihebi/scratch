\input{prelude}

\title{How to compute}
\begin{document}


\begin{figure*}[ht!]
  \centering
  \begin{tikzpicture}[
    cfg/.style={draw,rectangle,rounded corners},
    % func/.style={fill=yellow,opacity=1},
    tf/.style={text=\scriptsize},
    trans/.style={align=center,draw,rounded corners,rectangle
      split,rectangle split parts=2,draw,dashed,fill=gray!10!white,minimum width=5cm,font=\scriptsize\bfseries},
    bench/.style={draw,fill=gray!20!white},
    slice/.style={draw,ultra thick},
    merge label/.style={red,font=\scriptsize\bfseries,draw,rotate=-45,label position=40},
    every label/.style={font=\normalsize},
    num/.style={draw,circle},
    label position={0},
    font=\bfseries,
    ->
    ]

    \begin{scope}[every label quotes/.style={left}]
      \graph[grow down, branch right,
      nodes={draw,rectangle,rounded corners}
      ] {"\texttt{main}"["1"]
        -> "\texttt{a=argv[1];b=argv[2];}"["2"]
        -> "\texttt{func()}"["3"]
        -> thefor/"\texttt{for(p=a;*p!='\textbackslash0';p++)}"[slice,"4"]
        -> [edge quotes={auto,font=\footnotesize}] "\texttt{*p='y'}"[slice,"5",> "true"']
        -> forif/"\texttt{if(p)}"[slice,"6"]
        -> [edge quotes={auto,font=\footnotesize}] "\texttt{break}"[slice,"7",> "true"]
        -> strcpy/"\texttt{strcpy(buf,"short")}"[slice,"8"]
        -> "\texttt{strcat(a,b)}"[bench,slice,"9"]
        -> "\texttt{if(strlen(b)<1024)}"[slice,"10",label={[merge label,shift={(6mm,9mm)}]merge$\times$}]
        -> [edge quotes={auto,pos=0.8,font=\footnotesize}] {"\texttt{s=b}"[slice,shift={(-1,0)}, > "true"',"11"],
          "\texttt{s=a}"[bench,slice,> "false","12"]
        }
        -> "\texttt{z=x+y}"["13"]
        -> c8/"\texttt{if(c>8)}"[slice,"14",label={[merge label,shift={(-1mm,1mm)},green!40!black]merge$\surd$}]
        -> [edge quotes={auto, pos=0.6,font=\footnotesize}]
        {"\texttt{p=malloc(1024)}"[bench,slice,shift={(-1.5,0)},> "true"',"15"]
          -> "\texttt{buf=p}"[bench,slice,shift={(-1.5,0)},"16"],
          "\texttt{buf=buf2}"[shift={(1,0)},bench,slice,> "false","17"]}
        -> poi/"\texttt{strcpy(buf,s)}"[bench,slice,"18"]
      };
    \draw (forif) to[bend left,"false" auto, pos=0.5,font=\footnotesize] ($(thefor.south)+(-1.5,0)$);
    \draw ($(thefor.south)+(1,0)$) to[bend left, "false" auto, pos=0.3,font=\footnotesize] ($(strcpy.north)+(1,0)$);
    \end{scope}


    % \draw (poi) -- (c8);

    % \matrix[draw=red] {
    %   \node {a}; & \node {b}; & \node {c};\\
    % };

    % \matrix [draw=red,column sep=1cm]
    % {
    %   \node {8}; & \node{1}; & \node {6}; \\
    %   \node {3}; & \node{5}; & \node {7}; \\
    %   \node {4}; & \node{9}; & \node {2}; \\
    % };

    \matrix[
    every node/.style={anchor=north},
    anchor=south,
    above=of poi.south,
    shift={(0,-1.5)},
    every label quotes/.style={below,font=\footnotesize},
    % every label/.style={font=\footnotesize},
    align=center
    ] {
\node (input)
[shift={(0.4,0)},label={[font=\scriptsize,
  % draw,decorate, decoration={random steps,segment length=3pt,amplitude=1pt},fill=gray!20!white
  ]above:Input: Buggy Program}] {
  \begin{lstlisting}[
    label={lst-overview-example},
    basicstyle=\scriptsize\ttfamily,
    numbers=left
    ]
char *buf,*s,*a,*b;
void main(int argc,char *argv){
  (*@\color{blue}a=argv[1]; b=argv[2];@*)
  func();
  for(char *p=a;*p!='\0';p++){
    *p='y'; if (p) break;}
  strcpy(buf, "short");
  (*@\color{blue}strcat(a,b);@*)
  if (strlen(b)<1024) s=b;
  else (*@\color{blue}s=a;@*)
  z=x+y;
  (*@\color{blue}if (c>8)@*) {
    (*@\color{blue}p=malloc(1024); buf=p;@*)
  } (*@\color{blue}else@*) {
    (*@\color{blue}buf=buf2;@*)}
  (*@\color{red}strcpy(buf,s);@*)
}
\end{lstlisting}
}; &[7cm]
\node (output)
[shift={(0.4,0)},label={[font=\scriptsize,
  % draw,decorate, decoration={random steps,segment length=3pt,amplitude=1pt},fill=gray!20!white
  ]above:Output: Bug Signature}] {
  \begin{lstlisting}[
    label={lst-overview-example},
    basicstyle=\scriptsize\ttfamily,
    numbers=left
    ]
char *buf,*s,*a,*b;
void main(int argc,char *argv){
  char *a=argv[1];
  char *b=argv[2];
  strcat(a,b);
  s=a;
  if (c>8) {
    p=malloc(1024); buf=p;
  } else {
    buf=buf2;}
  (*@\color{red}strcpy(buf,s);@*)
}
\end{lstlisting}
};\\
\node {}; & \node {};\\
\node {}; & \node {};\\
\node (maincallbartrans)[trans,"2"] {
\texttt{\color{red}\underline{len($argv_1$)+len($argv_2$)>1024;}}
\nodepart{two}
\texttt{sizeof(buf')=1024;}\\
\texttt{\color{blue}\underline{len(s')=len($argv_1$)+len($argv_2$)};}
}; &
\node (strcattrans)[trans,"3-9"] {
  \texttt{len(a)+len(b)>1024;}
  \nodepart{two}
  \texttt{sizeof(buf')=1024;}\\
  \texttt{\color{blue}\underline{len(s')=len(a)+len(b)};}
}; \\
% \node (strcattrans)[trans,"11-15"] {
%   \texttt{{\color{blue}\underline{len(a)+len(b)}}>1024;}
%   \nodepart{two}
%   \texttt{sizeof(buf')=1024;}\\
%   \texttt{len(s')={\color{blue}\underline{len(a)+len(b)}};}
% }; &

\node (iflentrans1)[trans,"10-(1)"] {
$\emptyset$
\nodepart{two}
$\emptyset$
}; &

\node (iflentrans2)[trans,"10-(2)",label={[merge label,label distance=-5mm,shift={(10mm,10mm)},overlay]"merge$\times$"}] {
\texttt{len(a)>1024;}
\nodepart{two}
\texttt{size(buf')=1024;}\\
\texttt{len(s')=len(a);}
}; \\

\node (sbtrans)[trans,"11"] {
\texttt{len(b)>1024;}
\nodepart{two}
\texttt{size(buf')=1024;}\\
\texttt{\color{blue}\underline{len(s')=len(b);}}
}; &
\node (satrans)[trans,"12"] {
\texttt{len(a)>1024;}
\nodepart{two}
\texttt{size(buf')=1024;}\\
\texttt{\color{blue}\underline{len(s')=len(a)};}
}; \\

\node (c8trans) [trans,"14",label={[merge label,green!40!black,shift={(7mm,8mm)},overlay]"merge$\surd$"}] {
\texttt{len(s)>1024;}
\nodepart{two}
\texttt{\color{blue}\underline{size({buf'})=1024;}}\\
\texttt{len(s')=len(s);}
}; &

\node (buf2trans) [trans,"17"] {
\texttt{len(s)>size(buf2);}
\nodepart{two}
\texttt{\color{blue}{\underline{size({buf'})=size(buf2);}}}\\
\texttt{len(s')=len(s);}
}; \\

\node (malloctrans) [trans,"15"] {
\texttt{len(s)>1024;}
\nodepart{two}
\texttt{\color{blue}{\underline{size({buf'})=1024;}}}\\
\texttt{len(s')=len(s);}
}; &
\node (poitrans)[trans,"18"] {
\texttt{len(s)>size(buf);}
\nodepart{two}
\texttt{\color{blue}{\underline{size({buf'})=size(buf);}}}\\
\texttt{len(s')=len(s);}
}; \\

\node (assignbuftrans) [trans,"16"] {
\texttt{len(s)>size(p);}
\nodepart{two}
\texttt{\color{blue}\underline{size({buf'})=size(p);}}\\
\texttt{len(s')=len(s);}
}; &

\node (feature)[align=left,font=\scriptsize\bfseries,draw,decorate, decoration={random steps,segment length=3pt,amplitude=1pt},fill=gray!20!white,shift={(0,-0.3)}] {
  Query for Demand: \\\texttt{len(s')>size(buf')}
};\\
};
  \end{tikzpicture}
\end{figure*}

\end{document}
